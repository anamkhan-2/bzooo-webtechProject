<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>CRUD App - BeZoo Products</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <style>
    body { padding: 30px; background: #f5f7fa; }
    .spinner { display:none; margin:20px 0; text-align:center; }
  </style>
</head>
<body>
<div class="container">
  <h2 class="mb-4 text-center">ðŸ“‹ BeZoo Products CRUD</h2>

  <div id="alertBox"></div>

  <!-- Form -->
  <div class="card mb-4">
    <div class="card-header bg-primary text-white">Create / Update Product</div>
    <div class="card-body">
      <form id="productForm">
        <input type="hidden" id="productId">
        <div class="mb-3">
          <label>Name</label>
          <input type="text" id="name" class="form-control" required>
        </div>
        <div class="mb-3">
          <label>Price</label>
          <input type="number" id="price" class="form-control" required>
        </div>
        <div class="mb-3">
          <label>Category</label>
          <input type="text" id="category" class="form-control" required>
        </div>
        <div class="mb-3">
          <label>Description</label>
          <textarea id="description" class="form-control"></textarea>
        </div>
        <button type="submit" class="btn btn-success">Save</button>
        <button type="button" id="resetForm" class="btn btn-secondary">Clear</button>
      </form>
    </div>
  </div>

  <div class="spinner">
    <div class="spinner-border text-primary"></div>
  </div>

  <!-- Filter + Table -->
  <div class="row mb-3">
    <div class="col-md-3"><input type="text" id="filterCategory" class="form-control" placeholder="Category"></div>
    <div class="col-md-3"><input type="number" id="filterMin" class="form-control" placeholder="Min Price"></div>
    <div class="col-md-3"><input type="number" id="filterMax" class="form-control" placeholder="Max Price"></div>
    <div class="col-md-3"><button id="applyFilter" class="btn btn-primary">Filter</button></div>
  </div>

  <div class="table-responsive">
    <table class="table table-bordered text-center">
      <thead class="table-dark">
        <tr><th>Name</th><th>Price</th><th>Category</th><th>Description</th><th>Actions</th></tr>
      </thead>
      <tbody id="productsTable"></tbody>
    </table>
  </div>

  <nav>
    <ul class="pagination" id="pagination"></ul>
  </nav>
</div>

<script>
$(document).ready(function() {
  let currentPage = 1;
  const limit = 5;

  function showAlert(msg, type="success") {
    $("#alertBox").html(`<div class="alert alert-${type}">${msg}</div>`);
    setTimeout(()=> $("#alertBox").html(""), 3000);
  }

  function loadProducts(page=1, filters={}) {
    $(".spinner").show();
    let query = `?page=${page}&limit=${limit}`;
    if(filters.category) query += `&category=${filters.category}`;
    if(filters.minPrice) query += `&minPrice=${filters.minPrice}`;
    if(filters.maxPrice) query += `&maxPrice=${filters.maxPrice}`;

    $.get(`/api/products${query}`, function(data) {
      $(".spinner").hide();
      $("#productsTable").empty();
      data.products.forEach(p => {
        $("#productsTable").append(`
          <tr>
            <td>${p.name}</td>
            <td>${p.price}</td>
            <td>${p.category}</td>
            <td>${p.description || ''}</td>
            <td>
              <button class="btn btn-warning btn-sm editBtn" data-id="${p._id}" data-name="${p.name}" data-price="${p.price}" data-category="${p.category}" data-description="${p.description}">Edit</button>
              <button class="btn btn-danger btn-sm deleteBtn" data-id="${p._id}">Delete</button>
            </td>
          </tr>
        `);
      });

      // Pagination
      $("#pagination").empty();
      for(let i=1;i<=data.totalPages;i++){
        $("#pagination").append(`
          <li class="page-item ${i===page?'active':''}">
            <a class="page-link" href="#">${i}</a>
          </li>
        `);
      }
    });
  }

  loadProducts(currentPage);

  // Form submit
  $("#productForm").submit(function(e){
    e.preventDefault();
    const id = $("#productId").val();
    const payload = {
      name: $("#name").val(),
      price: $("#price").val(),
      category: $("#category").val(),
      description: $("#description").val()
    };

    if(id){
      $.ajax({
        url:`/api/products/${id}`,
        method:"PUT",
        contentType:"application/json",
        data:JSON.stringify(payload),
        success:()=> { showAlert("Updated successfully"); loadProducts(currentPage); resetForm(); },
        error:()=> showAlert("Update failed","danger")
      });
    } else {
      $.ajax({
        url:`/api/products`,
        method:"POST",
        contentType:"application/json",
        data:JSON.stringify(payload),
        success:()=> { showAlert("Created successfully"); loadProducts(currentPage); resetForm(); },
        error:()=> showAlert("Create failed","danger")
      });
    }
  });

  // Edit button
  $(document).on("click",".editBtn",function(){
    const btn = $(this);
    $("#productId").val(btn.data("id"));
    $("#name").val(btn.data("name"));
    $("#price").val(btn.data("price"));
    $("#category").val(btn.data("category"));
    $("#description").val(btn.data("description"));
    $("html,body").animate({scrollTop:0}, "smooth");
  });

  // Delete button
  $(document).on("click",".deleteBtn",function(){
    if(confirm("Delete this product?")){
      $.ajax({
        url:`/api/products/${$(this).data("id")}`,
        method:"DELETE",
        success:()=> { showAlert("Deleted successfully","danger"); loadProducts(currentPage); },
        error:()=> showAlert("Delete failed","danger")
      });
    }
  });

  // Reset form
  $("#resetForm").click(()=> resetForm());
  function resetForm(){ $("#productId").val(""); $("#productForm")[0].reset(); }

  // Filter
  $("#applyFilter").click(()=>{
    currentPage=1;
    loadProducts(currentPage,{
      category: $("#filterCategory").val(),
      minPrice: $("#filterMin").val(),
      maxPrice: $("#filterMax").val()
    });
  });

  // Pagination click
  $(document).on("click",".page-link", function(e){
    e.preventDefault();
    currentPage = parseInt($(this).text());
    loadProducts(currentPage,{
      category: $("#filterCategory").val(),
      minPrice: $("#filterMin").val(),
      maxPrice: $("#filterMax").val()
    });
  });
});
</script>
</body>
</html>
